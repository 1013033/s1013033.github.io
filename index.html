<!doctype html>
<html lang="en-US">
    <head>
        <meta charset="utf-8">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="csp-nonce" content="36764e5d-cc7f-49d0-a2d5-5649caf4f421">
        
        
        <meta name="description" content="æ¡ˆä¾‹åˆ†æå ±å‘Š">
        
        <title>æ¡ˆä¾‹åˆ†æå ±å‘Š - HackMD</title>
        <link rel="icon" type="image/png" href="https://hackmd.io/favicon.png">
        <link rel="apple-touch-icon" href="https://hackmd.io/apple-touch-icon.png">
        
<script nonce="36764e5d-cc7f-49d0-a2d5-5649caf4f421">
  window.domain = 'hackmd.io'
  window.urlpath = ''
  window.debug = false || window.localStorage.getItem('HMD_DEBUG_FLAG') === 'true'
  window.version = '1.3.0'
  window.brand = 'HackMD'

  

  window.GOOGLE_DRIVE_API_KEY = 'AIzaSyAHmcP5gL_64ZafuAYOvJruFAIaYgHQaY4'
  window.GOOGLE_DRIVE_CLIENT_ID = '65857506266-76uhhee8se8dgs1i0q8fhtj1prg0ar27.apps.googleusercontent.com'
  window.DROPBOX_APP_KEY = 'rdoizrlnkuha23r'
  
  window.PLANTUML_SERVER = 'https://ptuml.hackmd.io'

  window.ASSET_URL = 'https://assets.hackmd.io'

  window.USER_CAN_CREATE_TEAM = true
  window.USER_CAN_DELETE_ACCOUNT = true
  window.USER_DELETE_ACCOUNT_VIA_EMAIL = true
  window.PAYMENT_ENABLED = true
  window.PAYMENT_PROMOTION_BANNER_ENABLED = false
  window.GITHUB_SYNC_ENABLED = true
  window.GITLAB_SYNC_ENABLED = false
  window.GITLAB_SYNC_BASE_URL = ''
  window.VCS_SYNC_MODE = 'github'
  window.VCS_PROVIDER_NAME = 'GitHub'
  window.FREE_TEAM_NUM = 20
  window.FREE_TEAM_MEMBER_NUM = 3
  window.FREE_PUBLIC_TEAM_NUM = 10
  window.NEO_OVERVIEW_UI = false
  
  window.ALLOW_ANONYMOUS = true
  window.ALLOW_ANONYMOUS_EDIT = false
  window.ALLOW_DOWNLOAD_PDF = true
  window.PUBLIC_OVERVIEW = false
  window.INTERNAL_PUBLIC_OVERVIEW = false
  window.FULL_TEXT_SEARCH_ENABLE = false
  window.ALGOLIA_SEARCH_ENABLE = true
  window.MARKETING_EMAIL_ENABLE = true
  window.OFFLINE_ACCESS = true
  
  
  
    window.WALLET_CONNECT_PROJECT_ID = '91d6fa182b725b5895a17a170a5878c1'
  
  window.API_MANAGEMENT_UI_ENABLE = true
  window.FEEDBACK_UI_ENABLE = true
  window.PUBLISH_ENABLE = true

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  window.TRASH_NOTE_DELETE_AFTER_FREE = 3
  window.TRASH_NOTE_DELETE_AFTER_PAID = 30

  

  
    window.IS_OWNER_UPGRADED = false
  

  
    window.IMGUR_FALLBACK_CDN = 'https://imgur-backup.hackmd.io'
  

  
    window.CLOUD_META_UI = true
  
  
    window.CLOUD_META_API = true
  
  
    window.CLOUD_META_MIGRATION = false
  
  
    window.YAML_METADATA_ENABLED = false
  

  
    window.NOTE_CAPACITY_LIMIT = 50
  

  
    window.DOCUMENT_MAX_LENGTH = 100000
  

  
    window.SOCIAL_NETWORK_FEATURES_ENABLED = true
  

  
    window.PUBLISHMENT_MODERATION_ENABLED = true
  

  

  window.SUGGEST_EDIT_ENABLED = true
  

  
    window.REALTIME_CLIENT_WITH_CREDENTIALS = false
  

  

  
    window.DEBUG_DISCONNECT_SOCKET_WHEN_OFFLINE = false
  

  

  

  
    window.USE_NEW_LOGO = true
  

  
    window.ITERABLE_ENABLED = true
  
  
    window.ITERABLE_API_KEY = "c2c36a44c2614fb19aa3b46d660bbce2"
  

  

  
</script>


        
         <link href="https://assets.hackmd.io/build/font-vendor.ea8218d7d4f468b2c430.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/common-vendor.0a08ae20e14fefe857eb.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/slide-vendor.4f9ce891d775b406c282.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/slide.0d565f5ecb591b14b52c.css" rel="stylesheet">

        <!-- style-loader will insert style before this div in development -->
        <!-- This prevents overwriting reveal.js theme css -->
        <meta id="style-tag-insertion">

        <!-- For reveal.js theme -->
        
        <link rel="stylesheet" href="https://assets.hackmd.io/build/reveal.js/dist/theme/sky.css" id="theme">
        

        <!-- For overwrite reveal.js -->
        <link rel="stylesheet" href="https://hackmd.io/build/slide.css">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha256-3Jy/GbSLrg0o9y5Z5n1uw0qxZECH7C6OQpVBgNFYa0g=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js" integrity="sha256-g6iAfvZp+nDQ2TdTR/VVKJf3bGro4ub5fvWSWVRi2NE=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js" integrity="sha256-8E4Is26QH0bD52WoQpcB+R/tcWQtpzlCojrybUd7Mxo=" crossorigin="anonymous"></script>
<![endif]-->

    </head>
    <body>
        <div class="container" data-hard-breaks="true">
            <div class="reveal">
                <div class="slides" style="display: none;">

## SQL Server database deadlock
æ¡ˆä¾‹åˆ†æå ±å‘Š

---

## äº‹ä»¶å¦‚ä½•ç™¼ç”Ÿ?

```mermaid
gantt
    title Time Line
    section Upgrade
    SQL Server 2014 to 2019   :a1, 2024-08-09, 1d
    
    section Code
    éç¨‹ä¸­ç¨‹å¼æŒçºŒå„ªåŒ–èª¿æ•´        :after a1  , 20d 
    
    section Problem
    å¶çˆ¾ç™¼ç”Ÿ DeadLock           :2024-08-10  , 40d
    System Crash              : crit,2024-09-18  , 5d

```

&lt;!-- .slide: data-background=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/clock2.jpg&#34; data-background-opacity=&#34;0.3&#34; --&gt;

---

## å‰æƒ…æè¦...
:::info
* Qï¼šçµå ± &amp; GBAä»‹æ¥é–‹å‡ºå¤šå¼µå‚³ç¥¨çš„æƒ…æ³ï¼Ÿ
  * ä¸€ç­†API-Requestï¼ŒDBç”¢ç”Ÿå¤šç­†ç›¸åŒè³‡æ–™ 
* ç™¼ç”Ÿéç¨‹ä¸­ï¼Œåšäº†ç”šéº¼?
  * kill process
  * DB Server Restart
* é€ æˆçµæœ
  * å¯èƒ½ AP Server process Redo
:::


----

#### åœ¨ç³»çµ±Crashedå‰...ç¨‹å¼æ”¹äº†ç”šéº¼? 

:::info
Date: 113/08/20-113/09/07
SVN: 14413ã€14414ã€14415
:::

:::warning
* ã€Œè½‰è£½å‚³ç¥¨ã€æŒ‰éˆ•ã€è©¢å•è¦–çª—ä¹‹ã€Œç¢ºå®šã€æŒ‰éˆ•ç­‰ç­‰æ²’æœ‰é–å®šï¼Œèª¿æ•´ç‚ºæŒ‰ä¸‹æŒ‰éˆ•å°±åç°ã€‚
  * (é˜²æ­¢ä½¿è€…è€…å¯èƒ½åŒä¸€æ™‚é–“é»å¥½å¹¾æ¬¡è½‰è£½æŒ‰éˆ•ã€‚)
* è½‰è£½éç¨‹å¢åŠ é¡¯ç¤ºç­‰å¾…åœ–ç¤ºã€‚
  * (é˜²æ­¢ä½¿è€…è€…ç„¡æ³•åˆ¤æ–·æ˜¯å¦æœªæŒ‰ä¸‹è½‰è£½æŒ‰éˆ•ï¼Œæˆ–æ˜¯ä¸ç¢ºå®šç•«é¢æ˜¯å¦åœ¨æœ‰é€²è¡Œã€‚)
:::


----

:::info
Date: 113/08/20-113/09/07
SVN: 14413ã€14414ã€14415 (Cond.)
:::

:::warning
* å¾Œç«¯å¢åŠ æ§åˆ¶ï¼Œåœ¨æœ€å¾Œå¯«å…¥è³‡æ–™åº«å‰ï¼Œåˆ©ç”¨å‰ç«¯çš„bodyä¸²æµè½‰md5ä¾†åˆ¤æ–·ç›¸åŒçš„ç•«é¢æ˜¯å¦è¢«æäº¤å…©æ¬¡ã€‚
  * (é˜²æ­¢å‰ç«¯åŒæ™‚é–“é€å‡ºç›¸åŒçš„è«‹æ±‚ã€‚)
:::

----

:::info
SVN: 14497 
:::

:::warning
* Read &amp; Write ä½¿ç”¨ä¸åŒçš„ datasource
  * å‚³ç¥¨è¨ˆç®—é¤˜é¡(Read)
  * å‚³ç¥¨è³‡æ–™å­˜æª”(Write)
:::

----

:::info
SVN: 14497 
:::
:::warning
* ç›£æ§SQLåŸ·è¡Œçµæœ
  * å¢åŠ p6spyå·¥å…·ä¾†ç›£æ§SQLåŸ·è¡Œçµæœ(æš«æ™‚åƒ…é‡insertã€selectç´€éŒ„)ï¼Œä¸¦å¢åŠ logs\cgba-p6spy.logæª”æ¡ˆä¾†ç´€éŒ„åŸ·è¡Œéç¨‹ã€‚
:::
&lt;BR&gt;

&lt;img class=&#34;img&#34; src=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/image-3.png&#34; alt=&#34;&#34; style=&#34;transform: scale(1.2)&#34;&gt;

----

:::info
SVN: 14536 
:::

:::warning
* é™ä½è³‡æ–™åº«æŸ¥è©¢å‚³ç¥¨æ’ˆå–çš„è³‡æ–™é‡ï¼Œåªå–å¿…è¦è³‡æ–™
* &#34;SELECT * &#34; èˆ‡ &#34;SELECT att.1, att.2 &#34;åŸ·è¡Œæ™‚é–“å·®ç•°
:::

----

:::info
SVN: 14570 
:::

:::warning
* å°‡commité€²è¡Œè¨˜éŒ„ï¼Œå¯«è‡³logæª”ï¼Œç¢ºä¿commitæ­£å¸¸åŸ·è¡Œã€‚
:::
&lt;BR&gt;
 
&lt;img class=&#34;img&#34; src=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/image-4.png&#34; alt=&#34;&#34; style=&#34;transform: scale(1.2)&#34;&gt;

---

### æˆ‘åœ¨113å¹´9æœˆ20æ—¥åšäº†ç”šéº¼?
#### å—¯......Deadlock....æ‰€ä»¥......ğŸ˜•

---

## å·²çŸ¥çš„è³‡è¨ŠğŸ“§
&lt;BR&gt;
&lt;img class=&#34;img&#34; src=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/DeadLockMail.png&#34; alt=&#34;&#34; style=&#34;transform: scale(1.3)&#34;&gt;
&lt;BR&gt;&lt;BR&gt;

#### å—¯...ä»–åœ¨å¹¹å˜› ?ğŸ¤”

----

### SQL Statement 1 / 2
:::danger
æ²–éŠ·é¤˜é¡è¨ˆç®—....Join AG_Voucher
:::

&lt;BR&gt;
&lt;img class=&#34;img&#34; src=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/image.png&#34; alt=&#34;&#34; style=&#34;transform: scale(1.5)&#34;&gt;


----

### SQL Statement 2 / 2
:::danger
å‚³ç¥¨è³‡æ–™å¯«å…¥....Insert AG_Voucher
:::

&lt;BR&gt;
&lt;img class=&#34;img&#34; src=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/image-1.png&#34; alt=&#34;&#34; style=&#34;transform: scale(1.5)&#34;&gt;

---

### å—¯...é€™äº›è³‡è¨Šå°æˆ‘ä¾†èªªè¶³å¤ å— ?

&lt;BR&gt;

### ...æˆ‘ä¼¼ä¹éœ€è¦æ›´å¤šçš„è³‡è¨Š?......ğŸ˜•

----

## æˆ‘æ€éº¼æƒ³?ğŸ¤”
:::warning
* Cycle? 
* Deadlock é¡å‹æ˜¯?
* Deadlock åœ–é•·æ€æ¨£?
* å¯ä»¥ç”¨ SQL Server Profile å—?
* å¯ä»¥ç”¨ Extented Events å—?
:::

&lt;!-- .slide: data-background=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/think1.jpg&#34; data-background-opacity=&#34;0.6&#34; --&gt;

---

### ğŸ”–ç¬¬ä¸€æ­¥: æ”¶é›†æ›´å¤šè³‡æ–™

#### **ä½¿ç”¨ SQL Server Profile**

&lt;BR&gt;

#### **ä½¿ç”¨ Extented Events**

&lt;!-- .slide: data-background=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/data1.jpg&#34; data-background-opacity=&#34;0.4&#34; --&gt;

----

### SQL Server Profile
:::danger
ä½†...å¤±æ•—äº†....Why?ğŸ˜±
:::

:::danger
ğŸ”¥ Profileè³‡æ–™æ”¶é›†éœ€è€—è²»å¾ˆé«˜çš„åŸ·è¡Œæˆæœ¬ 
å°è‡´ GBA ç³»çµ±ç„¡æ³•é †åˆ©é‹ä½œï¼ŒDeadLockæ›´åŠ åš´é‡äº†
:::

:::warning
ğŸ“¢ **æœ‰ç”šéº¼æ›¿ä»£æ–¹æ¡ˆ?** 
æ“´å±•äº‹ä»¶(Extented Events)
:::

&lt;!-- .slide: data-background=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/SQL_Profiler.png&#34; data-background-opacity=&#34;0.4&#34; --&gt;

----

### Extented EventsğŸ‘
:::success
è¼•é‡ç´šçš„æ•ˆèƒ½ç›£æ§èˆ‡è³‡æ–™æ”¶é›†
:::

:::success
é è¨­å·²è¨­å®š system health
:::

:::danger
ä½†ï¼Œé è¨­çš„æ±è¥¿ï¼Œæª”æ¡ˆå¤ªå°ä¸”é›œè¨Šå¤ªå¤š
:::

----

:::danger
å—¯...ç‚ºäº†é•·æ™‚é–“æ”¶é›†è³‡è¨Š....
&lt;BR&gt;
æˆ‘éœ€è‡ªå·±å»ºç«‹å±¬æ–¼è‡ªå·±çš„Extented EventsğŸ˜•
:::

&lt;!-- .slide: data-background=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/system_health.png&#34; data-background-opacity=&#34;0.2&#34; --&gt;

----

#### å¦‚ä½•å»ºç«‹æ–°çš„Extented Events?(é€™è£¡ä¸è´…è¿°)
:::info
1. ç®¡ç† â†’ æ“´å……äº‹ä»¶ â†’ å·¥ä½œéšæ®µ â†’ã€Œæ–°å¢å·¥ä½œéšæ®µç²¾éˆã€ï¼Œé€éç²¾éˆå¼çš„å®Œæˆç›¸é—œè¨­å®šã€‚
2. è¨­å®šä¸€å€‹å·¥ä½œéšæ®µçš„åç¨±
3. å¯ä»¥çœ‹åˆ°é¡ä¼¼ SQL Profiler ï¼Œé¸æ“‡ã€ŒTSQL_Locksã€çš„ç¯„æœ¬
4. æ­¤æ™‚å¯ä»¥çœ‹åˆ°å³é‚Šã€Œé¸å–çš„äº‹ä»¶ã€ä¸­ï¼Œå·²ç¶“è‡ªå‹•åŠ å…¥ Deadlock æ‰€éœ€è¦ç´€éŒ„çš„è³‡è¨Šã€‚
5. ç‚ºäº†å¾ŒçºŒæ–¹ä¾¿æŸ¥è©¢å’Œä½¿ç”¨ï¼Œå»ºç«‹ä¸€å€‹ç›®éŒ„ç”¨ä¾†å­˜æ”¾æ“´å……äº‹ä»¶ä¸­æ‰€è¨˜éŒ„ä¸‹ä¾†çš„è³‡è¨Š
:::

---

### ğŸ”–ç¬¬äºŒæ­¥: å¦‚ä½•æ‰“é–‹æ”¶é›†åˆ°çš„è³‡è¨Š
* xml_deadlock_report
* DeadLockåœ–
* Locké¡å‹

&lt;!-- .slide: data-background=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/data2.jpg&#34; data-background-opacity=&#34;0.2&#34; --&gt;


----

### å¦‚ä½•å–å¾—xml_deadlock_report?
:::success
Extented Events
:::

&lt;BR&gt;
&lt;img class=&#34;img&#34; src=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/xml_deadlock_report.png&#34; alt=&#34;&#34; style=&#34;transform: scale(1.2)&#34;&gt;

----

### xml_deadlock_reporté•·é€™æ¨£...

```xml
&lt;deadlock&gt;
&lt;victim-list&gt;&lt;victimProcess id=&#34;process1719d45a108&#34;/&gt;&lt;/victim-list&gt;
&lt;process-list&gt;
&lt;process waitresource=&#34;PAGE: 24:1:969290 &#34; waittime=&#34;3957&#34; ownerId=&#34;37197047&#34; 
transactionname=&#34;implicit_transaction&#34; lockMode=&#34;IX&#34; 
clientapp=&#34;Microsoft JDBC Driver for SQL Server&#34; 
hostname=&#34;V5P-CGBA-AP5&#34; loginname=&#34;cgbasys&#34; 
isolationlevel=&#34;read committed (2)&#34; currentdbname=&#34;WGBA2300A&#34;&gt;
&lt;executionStack&gt;&lt;frame ...&gt; unknown &lt;/frame&gt;&lt;/executionStack&gt;
&lt;inputbuf&gt;(@P0 nvarchar(4000),@P55 varchar(8000),&lt;/inputbuf&gt;
&lt;/process&gt;
&lt;/process-list&gt;
&lt;/deadlock&gt;
```

---

### å—¯...æˆ‘è©²æ€éº¼è§£æå‘¢?ğŸ˜•

----

#### æˆ‘è©²æ€éº¼è§£æ xml_deadlock_report?ğŸ˜•
:::success
SolarWinds-PlanExplorer
:::
&lt;BR&gt;
&lt;img class=&#34;img&#34; src=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/SolarWinds-PlanExplorer.png&#34; alt=&#34;&#34; style=&#34;transform: scale(1.2)&#34;&gt;

----

####  æˆ‘è©²æ€éº¼å°‡ xml è½‰æ›æˆ XDL?
:::success
Deadlock gragh By ä½¿ç”¨ SolarWinds-PlanExplorer
:::
&lt;BR&gt;
&lt;img class=&#34;img&#34; src=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/DeadLockGragh.png&#34; alt=&#34;&#34; style=&#34;transform: scale(1.2)&#34;&gt;

----

#### SQL Serverç´€éŒ„ç”šéº¼?
:::success
S mode and IX mode deadlock
:::
&lt;BR&gt;
&lt;img class=&#34;img&#34; src=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/image-2.png&#34; alt=&#34;&#34; style=&#34;transform: scale(1.3)&#34;&gt;

---

### ğŸ”–ç¬¬ä¸‰éƒ¨: æŸ¥çœ‹ DeadLock è³‡è¨Š

:::success
xml_deadlock_report
&lt;BR&gt;
DeadLock Graph
:::

----

### å—¯...æˆ‘å¾—åˆ°äº†ç”šéº¼?

&lt;BR&gt;

### æˆ‘çš„ç“¶é ¸åœ¨å“ªè£¡?ğŸ˜•

----

### æˆ‘å¾—åˆ°äº†
:::info
* Write-Read lock
* Page Lock
* lock type IX
* Lock Escalation(æ“´å¤§é–å®š)
* ç“¶é ¸åœ¨ AG_Voucher è³‡æ–™è¡¨
:::


&lt;!-- .slide: data-background=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/office3.jpg&#34; data-background-opacity=&#34;0.2&#34; --&gt;

----

#### æ­¤æ™‚ï¼Œæµ®ç¾äº†å¹¾å€‹ç–‘å•......ğŸ¤”
:::danger
* é–å®šé¡å‹æ˜¯ Write-Read Lock.
    * Process 1 æ“æœ‰ S-Lock(å…±äº«é–)ï¼Œand ç­‰å¾… IX-Lock(æ„å‘é–)
    * Process 2 æ“æœ‰ IX-Lock(æ„å‘é–)ï¼Œand ç­‰å¾… S-Lockï¼ˆå…±äº«é–ï¼‰
* ç‚ºç”šéº¼é–å®šä¸æ˜¯ Row Lock? 
* ç‚ºä½•ç™¼ç”ŸLock Escalation?
* ç‚ºç”šéº¼ INSERT æŒ‡ä»¤æœƒåŸ·è¡Œé€™éº¼ä¹…?
* æˆ‘çš„äº¤æ˜“æœ‰æ­£å¸¸commitå—
* Indexæ˜¯å¦æœ‰ç ´ç¢? 
:::


&lt;!-- .slide: data-background=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/office7.jpg&#34; data-background-opacity=&#34;0.2&#34; --&gt;

---

### âœ¨éç¨‹ä¸­ï¼Œå˜—è©¦äº†è¨±å¤šæ–¹æ³•
:::warning
* Try 1: åœç”¨ lock escalation
* Try 2: æª¢æŸ¥ index ç ´ç¢ç™¾åˆ†æ¯”
* Try 3: äº¤æ˜“è®€å¯«åˆ†é›¢
* Try 4: èª¿æ•´ JDBC connection timeout è¨­å®š
* Try 5: æ›´æ–° SQL SERVER patch
* Try 6: æ›´æ–° JDBC Driver for SQL Server
:::

&lt;!-- .slide: data-background=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/office6.jpg&#34; data-background-opacity=&#34;0.2&#34; --&gt;

---

### ç‚ºç”šéº¼æˆ‘æ‡·ç–‘ lock escalation?
:::danger
* å› ç‚º Extented Events å‘Šè¨´äº†æˆ‘ 
* è€Œä¸”ç™¼ç”Ÿé »ç‡æ¥µé«˜
* æ‰€ä»¥æˆ‘æ‡·ç–‘.....
:::
&lt;BR&gt;
&lt;img class=&#34;img&#34; src=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/lock_escalation.png&#34; alt=&#34;&#34; style=&#34;transform: scale(1.1)&#34;&gt;

----

### ğŸ’«å˜—è©¦åœç”¨ lock escalation

:::warning
å¦‚ä½•ç¢ºå®šæ˜¯ lock escalation
:::

:::success
æŸ¥çœ‹ Extended Events sæ˜¯å¦åŒ…å« lock_escalation event.
:::

:::danger
**But intent lock (such as a lock mode of IS, IU, or IX), this isn&#39;t caused by lock escalation.** (ç•¶ä¸‹æ²’æ³¨æ„åˆ°é€™ä¸€é»ğŸ˜¤)
:::

----

### å¦‚ä½•åœç”¨ lock escalation
```sql
ALTER TABLE ... SET (LOCK_ESCALATION = DISABLE)
```
&lt;BR&gt;

### å¦‚ä½•å•Ÿç”¨ lock escalation
```sql
ALTER TABLE ... SET (LOCK_ESCALATION = TABLE)
```

---

### ğŸ’« INSERT æŒ‡ä»¤ç‚ºä½•åŸ·è¡Œé€™éº¼ä¹…?
:::warning
* å¯èƒ½å› ç´ : Index ç ´ç¢
  * 15% ä»¥ä¸‹ï¼šæ­£å¸¸
  * 15% - 30%: REORGANIZE 
  * è¶…é 30%: REBUILD
  * çµæœ: æ•¸å€¼åœ¨æ­£å¸¸ç¯„åœ
:::
&lt;BR&gt;
&lt;img class=&#34;img&#34; src=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/page_fragment.png&#34; alt=&#34;&#34; style=&#34;transform: scale(1.1)&#34;&gt;


----

### ğŸŒŸæ„å¤–ç™¼ç¾å…¶ä»–indexå•é¡ŒğŸŒŸ
:::success
* ç›¸åŒindexé‡è¤‡å»ºç«‹2æ¬¡ 
* æœ‰ä½•å½±éŸ¿? é€ æˆinsertåŸ·è¡Œæ™‚é–“æ‹‰é•·
* æ„Ÿè¬ï¼šä¸­è²é›»è…¦
:::
&lt;BR&gt;
&lt;img class=&#34;img&#34; src=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/same_index.png&#34; alt=&#34;&#34; style=&#34;transform: scale(1.2)&#34;&gt;


---

### ğŸ’«å˜—è©¦é€²è¡Œäº¤æ˜“è®€å¯«åˆ†é›¢
:::danger
* ä¿®æ”¹å‚³ç¥¨å­˜æª”ç¨‹å¼
* çµæœ: å•é¡Œä¾ç„¶å­˜åœ¨ğŸ˜¨
* æ„Ÿè¬ï¼šé•·å®˜å»ºè­°
:::

---

### ğŸ’«å˜—è©¦èª¿æ•´ Tomcat JDBC connection timeout
:::danger
* ä¿®æ”¹ JDBC connection pool è¨­å®š
* çµæœ: å•é¡Œä¾ç„¶å­˜åœ¨ğŸ˜®â€ğŸ’¨
* æ„Ÿè¬ï¼šé•·å®˜å»ºè­°
:::

---

### ğŸ’«å˜—è©¦æ›´æ–° SQL SERVER patch
:::warning
* æ‰‹å‹•æ›´æ–° KB5042214 and KB5042749 patch (ç™¼è¡Œæ—¥æœŸï¼š 2024 å¹´ 8 æœˆ 1 æ—¥ï¼Œç‰ˆæœ¬ï¼š 15.0.4385.2) 
* çµæœ: å•é¡Œä¾ç„¶å­˜åœ¨ğŸ˜µ
* æ„Ÿè¬ï¼šç¶­é‹ç§‘ã€è—æ–°è³‡è¨Šå”åŠ©
:::
&lt;BR&gt;
&lt;img class=&#34;img&#34; src=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/KB5039747.png&#34; alt=&#34;&#34; style=&#34;transform: scale(1.1)&#34;&gt;


---


#### ğŸ’«å˜—è©¦æ›´æ–° JDBC Driver for SQL Server
:::success
* æ›´æ–°ç‰ˆæœ¬å¾ 4.X åˆ° 12.8.1 (ç‰ˆæœ¬è™Ÿç¢¼ï¼š12.8.1 ç™¼è¡Œæ—¥æœŸ: 2024å¹´8æœˆ22æ—¥)
* éç¨‹ä¸­, å˜—è©¦æ›´æ–°åˆ° 7.4 ä½†ç³»çµ±åŠŸèƒ½å¤±æ•ˆ.
* çµæœï¼šå¥½åƒæˆåŠŸäº†ï¼Œæ„Ÿè¬æ™¶èŒ‚å…¬å¸ ğŸ‘Œ
:::
&lt;BR&gt;
&lt;img class=&#34;img&#34; src=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/JDBC_SQL_SERVER.png&#34; alt=&#34;&#34; style=&#34;transform: scale(1.1)&#34;&gt;

---

## å„æ–¹å»ºè­°å› ç³»çµ±å·²ç©©å®šï¼Œæ‰€ä»¥æœªå˜—è©¦é€²è¡Œ

----

#### å»ºè­° 1: èª¿æ•´ JDBC unreturnConnectionTimeout 
```xml
&lt;property name=&#34;hibernate.c3p0.unreturnedConnectionTimeout&#34;&gt;30&lt;/property&gt;
&lt;property name=&#34;hibernate.c3p0.debugUnreturnedConnectionStackTraces&#34;&gt;true&lt;/property&gt;
```
* æ„Ÿè¬ï¼šé•·å®˜å»ºè­°

----

#### å»ºè­° 2: read committed snapshot isolation
:::info
* å°‡ TRANSACTION ISOLATION LEVEL è¨­å®šç‚º read committed snapshot isolation 
* æ„Ÿè¬ï¼šMicrosoft SQL Team
:::

&lt;BR&gt;
&lt;img class=&#34;img&#34; src=&#34;https://raw.githubusercontent.com/1013033/Pic/refs/heads/main/read_committed_snapshot_isolation.png&#34; alt=&#34;&#34; style=&#34;transform: scale(1.1)&#34;&gt;

----

#### å»ºè­° 3: Using &#39;nolock&#39; parameter
:::info
* ç•¶ç„¶æ ¹æ“šæ‚¨çš„é¡§æ…®å’Œç³»çµ±å°è³‡æ–™æ•æ„Ÿåº¦çš„è€ƒæ…®ï¼Œæˆ‘å€‘å¯ä»¥å˜—è©¦å¦ä¸€ç¨®æ–¹æ³•ï¼šä½¿ç”¨â€œnolockâ€åƒæ•¸ï¼Œè®“SELECTèªå¥ä¸è¦ç”³è«‹Sé–ï¼Œæ¸›å°‘é–çš„ç”³è«‹æ•¸ç›®ï¼Œå¾è€Œæ¶ˆé™¤æ­»é–
* æ„Ÿè¬ï¼šMicrosoft SQL Team
:::
```sql
SELECT attribute_1,attribute_2... FROM TABLE withï¼ˆnolockï¼‰ WHERE...
```

----

#### æˆ‘çš„ç–‘å•ï¼Œä¾†è‡ªMicrosoftçš„å›è¦†å…§å®¹?
:::warning
* Q1: æœ‰é—œdeadlockæƒ…å½¢èˆ‡SQL serverå‡ç´šæ˜¯å¦æœ‰é—œ
  * Ans: deadlockç™¼ç”Ÿåœ¨ä½µç™¼æ€§æ–¹é¢ï¼Œç•¶äº‹å‹™è«‹æ±‚é–ä¹‹é–“è¢«äº’ç›¸ä½”ç”¨æ™‚æœƒç™¼ç”Ÿæ­»é–ï¼Œæ‰€ä»¥æˆ‘èªç‚ºèˆ‡å‡ç´šæ²’æœ‰å¤ªå¤§é—œä¿‚ã€‚
* Q2: JDBCçš„å‡ç´šæ˜¯å¦èˆ‡æ­»é–æœ‰é—œï¼Ÿ
  * Ans: æˆ‘èªç‚ºé€ æˆæ­»é–çš„ä¸»è¦åŸå› åœ¨æ–¼äº‹å‹™ç”³è«‹é–çš„ç›¸äº’ä½”ç”¨ï¼Œç•¶ç„¶ä¹Ÿä¸æ’é™¤æœƒæœ‰ä¸€é»å½±éŸ¿ï¼Œé€ æˆä½µç™¼æ€§å·®è€Œå°è‡´æ­»é–ã€‚
:::

----

## ä¾†è‡ªMicrosoftçš„å¾ŒçºŒå»ºè­°
:::warning
* å¦‚æœæ‚¨å†æ¬¡é€ æˆæ­»é–å•é¡Œï¼Œå¯ä»¥é€šéé–‹å•Ÿè·Ÿè¹¤æ¨™èªŒ1222ï¼Œé€šéåˆ†æerror logåˆ¤æ–·æ­»é–çš„é¡å‹ï¼ŒåŒæ™‚åˆ†æsystem healthæ–‡ä»¶åˆ¤æ–·é€ æˆæ­»é–çš„é¡å‹æ˜¯å¦æ˜¯åŒä¸€é¡ï¼Œå¦‚æ­¤caseä¸­çš„read-writeé¡æ­»é–å•é¡Œï¼Œå¯ä»¥å˜—è©¦æ­¤ç¸½çµçš„æ–¹æ³•ã€‚
:::

```sql
DBCC TRACEON (1222, -1)
DBCC TRACEON (1204, -1)

DBCC TRACESTATUS;
GO
```

---

## ç¸½çµ
:::danger
* æœ¬æ¬¡äº‹ä»¶ï¼Œç›®å‰æ¨æ¸¬æ˜¯ï¼ŒSQL Server 2019èˆ‡JDBCç‰ˆæœ¬ä¹‹é–“çš„é…åˆå°è‡´
* æœªä¾†åœ¨é€²è¡Œå„é …ç”¢å“èˆ‡å…ƒä»¶æ›´æ–°æ™‚ï¼Œæ‡‰å¤šåŠ ç•™æ„ã€‚
* æœ¬äº‹ä»¶éç¨‹ä¸­çš„ä»»ä½•æ€è€ƒï¼Œçš†å¯æˆç‚ºå¾ŒçºŒè™•ç†deadlockå•é¡Œçš„é¤Šåˆ†ã€‚
:::

----

### æ”¹é€²æªæ–½èˆ‡æ–¹å‘
:::warning
* å‰–æGBAç³»çµ±ç¨‹å¼æ¡†æ¶ï¼ŒæŒæ¡Requestçš„ç”Ÿå‘½é€±æœŸ
* å»ºæ§‹ç³»çµ±æ ¸å¿ƒæµç¨‹é—œè¯åœ–ï¼Œå”åŠ©åˆ¤æ–·äº‹ä»¶æ ¹å› åŠå½±éŸ¿ç¯„åœã€‚
* æå‡ºç³»çµ±é‡å¤§ç•°å‹•ç®¡ç†è¨ˆç•«ï¼Œè©•ä¼°å½±éŸ¿ä¸¦æ–¼æ¸¬è©¦ç’°å¢ƒè©¦è¡ŒåŠé€²è¡Œå£“åŠ›æ¸¬è©¦å¾Œä¸Šç·šã€‚
* å°ˆæ¡ˆåœ˜éšŠå¢åŠ ç³»çµ±ç®¡ç†äººå“¡ï¼Œå”åŠ©æŒæ¡ç³»çµ±é‹è¡Œæƒ…å½¢åŠè©•ä¼°é‡å¤§ç•°å‹•å½±éŸ¿ã€‚
* å¢åˆ—å§”å¤–å» å•†åˆ°å ´å”åŠ©ç·Šæ€¥è™•ç†ä¹‹ç›¸é—œè¦å®šã€‚
:::

</div>
            </div>

            <div id="meta" style="display: none;">{&#34;slideOptions&#34;:&#34;{\&#34;theme\&#34;:\&#34;sky\&#34;,\&#34;transition\&#34;:\&#34;slide\&#34;,\&#34;spotlight\&#34;:{\&#34;enabled\&#34;:true}}&#34;,&#34;title&#34;:&#34;æ¡ˆä¾‹åˆ†æå ±å‘Š&#34;,&#34;description&#34;:&#34;æ¡ˆä¾‹åˆ†æå ±å‘Š&#34;,&#34;contributors&#34;:&#34;[{\&#34;id\&#34;:\&#34;63ff34aa-0248-490a-b3d8-08064b14e8c7\&#34;,\&#34;add\&#34;:11114,\&#34;del\&#34;:251}]&#34;}</div>

            
        </div>

        
         <script src="https://assets.hackmd.io/build/font-vendor.eaa8dd82d4e056021b8c.js" defer="defer"></script><script src="https://assets.hackmd.io/build/common-vendor.04da453a2a68f624f4d4.js" defer="defer"></script><script src="https://assets.hackmd.io/build/slide-vendor.860ac3abbcf53e23341c.js" defer="defer"></script><script src="https://assets.hackmd.io/build/slide-common.fb0162a2ceea4f101052.js" defer="defer"></script><script src="https://assets.hackmd.io/build/slide.b6fd75e1351ad1823c24.js" defer="defer"></script>
    </body>
</html>


